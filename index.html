<html lang="zh">
<head>
    <meta
            name = "viewport"
            content = "width = device-width, initial-scale = 1.0, maximum-scale = 1.0, user-scalable = no"
    />
    <meta
            http-equiv="Content-Type"
            content="text/html; charset=utf-8"
    />
    <link
            rel = "stylesheet"
            type = "text/css"
            href = "./css/style.css"
    />
    <!--link
        rel="stylesheet"
        href="https://fonts.font.im/css?family=Oxygen+Mono"
    /-->
    <script
            src="./js/vue.js"
    ></script>
    <script
            src="./js/main.js"
    ></script>
    <title>ArectShell</title>
</head>
<body>
<header>
    <div class = "aboutMe">
        Hi~ <br />
        This page was inspired by <a href = "https://axton.cc" target = "_blank">axton</a>.<br />
        <span style = "color: #F44336;">
            Known issue: Sometimes the cursor does not appear when clicking "input here".
        </span>
    </div>
    <div class = "introduce" id="shellMessage">
        {{ name }} {{ version }}
        <span v-if = "isBeta" style = "color: #FF9800">beta</span>
    </div>
</header>
<div class = "commandHistory" id = "commandHistory">
    <div v-for = "(item, index) in prompts" class = "historyItem">
        {{ item }} {{ commands[index] }}<br />
        <div v-for = "i in results[index]">
            <div v-if = "i.isHtml" v-html = "i.result"></div>
            <div v-else v-text = "i.result"></div>
        </div>
    </div>
</div>
<div class = "commandMain">
    <div id = "commandInput" spellcheck = "false" autocomplete = "off">
        <span id = "prompt" v-text = "toString_()"></span>
        <span
                contenteditable = "true"
                id = "inputCommand"
                v-bind:class = "{ commandInput: !isFocused, commandFocus: isFocused }"
                v-on:focus = "inputFocus(true)"
                v-on:blur = "inputFocus(false)"
                v-on:keydown.enter = "exec()"
                v-on:keydown.up = "lastCommand()"
                v-on:keydown.down = "nextCommand()"
                ref = "command"
        >
        </span>
    </div>
</div>
</body>
<script>
    let mode = new Vue({
        data: {
            sign: "",
            content: "",
        },
        methods: {
            sudo: function() {
                this.isActive = true;
                this.content = "[sudo] password for " + prompt.username + ":";
            },
            normal: function() {
                this.isActive = false;
                this.content = "";
            }
        }
    });
    let prompt = new Vue ({
        el: "#prompt",
        data: {
            username: "visitor",
            device: "kanofans_com",
            directory: ["~"],
            authority: "$"
        },
        methods: {
            toString_: function() {
                if (mode.sign !== "") {
                    return mode.content;
                }
                return this.toString = "[" + this.username + "@" + this.device + " " + this.directory[this.directory.length - 1] + "] " + this.authority;
            },
            getFullDir: function () {
                let temp = "";
                for (let i of this.directory) {
                    temp += "/" + i;
                }
                return temp;
            }
        }
    });
    let shell = new Vue({
        el: "#shellMessage",
        data: {
            name: "Arect Shell",
            version: "0.9.2",
            isBeta: true,
            local: [
                {name: "0", value: "-ArectShell"},
                {name: "PWD", value: prompt.getFullDir()},
                {name: "DEVICE", value: prompt.device},
                {name: "SHELL", value: "/usr/bin/ArectShell"},
                {name: "USER", value: prompt.username},
                {name: "USERNAME", value: prompt.username},
                {name: "ARECT", value: "A very handsome man."}
            ],
            fileTree: [{
                name: "~",
                owner: "visitor",
                isDir: true,
                content: [{
                    name: "testDir",
                    isDir: true,
                    content: [{
                        name: "second.file",
                        isDir: false,
                        content: ["<h1 style = \"color: #999999\">第二个文件</h1>"]
                    }]
                },{
                    name: "test.txt",
                    isDir: false,
                    content: ["这是test.txt", "这是test.txt的第二行"]
                }]
            }]
        },
        methods: {
            getCurrentLocation: function() {
                let temp = this.fileTree;
                for (let i of temp) {
                    if (i.owner === prompt.username) {
                        temp = i;
                        for (let ii = 1; ii < prompt.directory.length; ii++) {
                            let isFound = false;
                            for (let iii of temp.content) {
                                if (iii.name === prompt.directory[ii]) {
                                    isFound = true;
                                    temp = iii;
                                    break;
                                }
                            }
                            if (!isFound) {
                                return "ERR_NO_SUCH_DIR_OR_FILE";
                            }
                        }
                        return temp;
                    }
                }
                return temp;
            },
            findFather: function(child) {
                let list = [];
                for (let i of this.fileTree) {
                    if (child === i) {
                        return "ERR_PERMISSION_DENIED";
                    }
                    if (i.isDir) {
                        list.push(i);
                    }
                }
                while (list.length > 0) {
                    let temp = list.shift();
                    if (temp.isDir) {
                        for (let i of temp.content) {
                            if (i === child) {
                                return temp;
                            }
                            if (i.isDir) {
                                list.push(i);
                            }
                        }
                    }
                }
            },
            getUserDir: function() {
                for (let i of this.fileTree) {
                    if (i.owner === prompt.username) {
                        return i;
                    }
                }
                return "ERR_IN_FINDING_USER_DIR";
            },
            enterTargetDir: function(arr) {
                if (Object.prototype.toString.call(arr) === "[object String]") {
                    arr = arr.trim().replace(new RegExp('^\\/+|\\/+$', 'g'), '').split("/");
                }
                if (Object.prototype.toString.call(arr) !== "[object Array]") {
                    console.log("ERR_PARAMETER_TYPE_ERROR");
                    return "ERR_NO_SUCH_DIR_OR_FILE";
                }
                // 相对路径
                let temp = shell.getCurrentLocation();
                let isFound = false;
                if (arr.length === 0) {
                    return temp;
                }
                for (let i of arr) {
                    isFound = false;
                    if (i === ".") {
                        isFound = true;
                        continue;
                    }
                    if (i === "..") {
                        temp = shell.findFather(temp);
                        if (Object.prototype.toString.call(temp) === "[object String]") {
                            return temp;
                        }
                        isFound = true;
                        continue;
                    }
                    for (let ii of temp.content) {
                        if (i === ii.name) {
                            isFound = true;
                            temp = ii;
                            break;
                        }
                    }
                    if (!isFound) {
                        break;
                    }
                }
                if (isFound) {
                    return temp;
                }
                else {
                    if (arr[0] === "~") {
                        isFound = true;
                        arr.shift();
                    } else return "ERR_NO_SUCH_DIR_OR_FILE";
                    temp = this.getUserDir();
                    if (temp === "ERR_IN_FINDING_USER_DIR") {
                        console.log(temp);
                        return "ERR_IN_FINDING_USER_DIR";
                    }
                    for (let i of arr) {
                        isFound = false;
                        if (i === ".") {
                            isFound = true;
                            continue;
                        }
                        if (i === "..") {
                            temp = this.findFather(temp);
                            if (Object.prototype.toString.call(temp) === "[object String]") {
                                return temp;
                            }
                            isFound = true;
                            continue;
                        }
                        for (let ii of temp.content) {
                            if (i === ii.name) {
                                isFound = true;
                                temp = ii;
                                break;
                            }
                        }
                        if (!isFound) {
                            break;
                        }
                    }
                    if (isFound) {
                        return temp;
                    }
                }
                return "ERR_NO_SUCH_DIR_OR_FILE";
            },
        }
    });
    let commandHistory = new Vue ({
        el: "#commandHistory",
        data: {
            prompts: [],
            commands: [],
            results: [],
        }
    });
    let inputCommand = new Vue ({
        el: "#inputCommand",
        data: {
            isFocused: false,
            command: [
                {name: "cat", variable: c_cat},
                {name: "cd", variable: c_cd},
                {name: "clear", variable: c_clear},
                {name: "date", variable: c_date},
                {name: "echo", variable: c_echo},
                {name: "help", variable: c_help},
                {name: "html", variable: c_html},
                {name: "ls", variable: c_ls},
                {name: "mkdir", variable: c_mkdir},
                {name: "screenfetch", variable: c_screenfetch},
                {name: "shutdown", variable: c_shutdown},
                {name: "template", variable: template}
            ],
            commandAmount: commandHistory.commands.length
        },
        methods: {
            exec: function() {
                // 输入一个命令按下回车，阻止产生<br />，如果有更好的办法就好了。
                event.preventDefault();
                this.commandAmount = commandHistory.commands.length;
                if (!mode.isActive) {
                    let command = this.$refs.command.innerText.trim().split(/\s+/);
                    commandHistory.prompts.push(prompt.toString_());
                    commandHistory.commands.push(this.$refs.command.innerText);
                    this.select(command);
                    this.$refs.command.innerHTML = "";
                }
            },
            select: function(command) {
                for (let i of this.command) {
                    if (command[0] === i.name) {
                        if (command.length > 1) {
                            if (command[1] === "--help") {
                                commandHistory.results.push(i.variable.help());
                                this.$refs.command.innerHTML = "";
                                return;
                            }
                        }
                        let temp = i.variable.main(command);
                        if (temp !== "$EMPTY$") {
                            commandHistory.results.push(temp);
                        }
                        return;
                    }
                }
                commandHistory.results.push([{isHtml: false, result: "-ArectShell: command not found: " + command[0]}]);
            },
            inputFocus: function(b) {
                if(this.$refs.command.innerText === ''){
                    this.isFocused = b;
                }
            },
            lastCommand: function () {
                if (this.commandAmount < 0) {
                    this.commandAmount = 0;
                }
                if (commandHistory.commands.length === 0) {
                    return;
                }
                if (this.commandAmount >= commandHistory.commands.length) {
                    this.commandAmount = commandHistory.commands.length - 1;
                }
                this.$refs.command.innerHTML = commandHistory.commands[this.commandAmount];
                this.commandAmount--;
            },
            nextCommand: function () {
                if (this.commandAmount >= commandHistory.commands.length) {
                    this.commandAmount = commandHistory.commands.length - 1;
                }
                if (commandHistory.commands.length === 0) {
                    return;
                }
                if (this.commandAmount < 0) {
                    this.commandAmount = 0;
                }
                this.$refs.command.innerHTML = commandHistory.commands[this.commandAmount];
                this.commandAmount++;
            }
        }
    });
    
</script>
</html>