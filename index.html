<html>
    <head>
        <meta
            name = "viewport"
            content = "width = device-width, initial-scale = 1.0, maximum-scale = 1.0, user-scalable = no"
        >
        <link
            rel = "stylesheet"
            type = "text/css"
            href = "./css/style.css"
        >
        <link href="https://fonts.font.im/css?family=Oxygen+Mono" rel="stylesheet">
        <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
        <title>ArectShell</title>
    </head>
    <body>
        <header>
            <div class = "aboutMe">
                Hi~ <br />
                This page was inspired by <a href = "https://axton.cc" target = "_blank">axton</a>.<br />
                <span style = "color: #F44336;">
                    Known issue: 1. Sometimes the cursor does not appear when clicking "input here".
                </span>
                <br />
                Current progress: no backend.
            </div>
            <div class = "introduce">
                Arect Shell v0.4.0
            </div>
        </header>
        <div class = "commandHistory" id = "commandHistory">
            <div v-for = "(item, index) in prompts" class = "historyItem">
                {{ item }} {{ commands[index] }}<br />
                <div v-for = "i in results[index]">
                    <div v-if = "i.isHtml" v-html = "i.result"></div>
                    <div v-else v-text = "i.result"></div>
                </div>
            </div>
        </div>
        <div class = "commandMain">
            <div id = "commandInput" spellcheck = "false" autocomplete = "off" autocorrect = "off">
                <span id = "prompt" v-text = "toString_()"></span>
                <span
                    contenteditable = "true"
                    id = "inputCommand"
                    v-bind:class = "{ commandInput: !isFocused, commandFocus: isFocused }"
                    v-on:focus = "inputFocus(true)"
                    v-on:blur = "inputFocus(false)"
                    v-on:keydown.enter = "exec()"
                    ref = "command"
                >
                </span>
            </div>
        </div>
    </body>
    <script>
        var prompt = new Vue ({
            el: "#prompt",
            data: {
                username: "visitor",
                device: "kanofans_com",
                directory: ["~"],
                authority: "$"
            },
            methods: {
                toString_: function() {
                    return this.toString = "[" + this.username + "@" + this.device + " " + this.directory[this.directory.length - 1] + "] " + this.authority;
                },
                getFullLocation: function() {
                    let temp = "~";
                    for (let index = 1; index < this.directory.length; index++) {
                        temp += "/" + this.directory[index];
                    }
                    return temp;
                },
                getCurrentLocation: function() {
                    let temp = d_fileTree.fileTree;
                    for (let i of temp) {
                        if (i.owner = this.username) {
                            temp = i;
                            for (let ii = 1; ii < this.directory.length; ii++) {
                                let isFound = false;
                                for (let iii of temp.content) {
                                    if (iii.name == this.directory[ii]) {
                                        isFound = true;
                                        temp = iii;
                                        break;
                                    }
                                }
                                if (!isFound) {
                                    return "ERR_NO_SUCH_DIR_OR_FILE";
                                }
                            }
                            return temp;
                        }
                    }
                    return temp;
                },
                findFather: function(child) {
                    let list = [];
                    for (let i of d_fileTree.fileTree) {
                        if (child === i) {
                            return "ERR_PERMISSION_DENIED";
                        }
                        if (i.isDir) {
                            list.push(i);
                        }
                    }
                    while (list.length > 0) {
                        let temp = list.shift();
                        if (temp.isDir) {
                            for (let i of temp.content) {
                                if (i === child) {
                                    return temp;
                                }
                                if (i.isDir) {
                                    list.push(i);
                                }
                            }
                        }
                    }
                },
                getUserDir: function() {
                    for (let i of d_fileTree.fileTree) {
                        if (i.owner == this.username) {
                            return i;
                        }
                    }
                    return "ERR_IN_FINDING_USER_DIR";
                },
                enterTargetDir: function(arr) {
                    if (Object.prototype.toString.call(arr) == "[object String]") {
                        arr = arr.trim().replace(new RegExp('^\\/+|\\/+$', 'g'), '').split("/");
                    }
                    if (Object.prototype.toString.call(arr) != "[object Array]") {
                        console.log("ERR_PARAMETER_TYPE_ERROR");
                        return "ERR_NO_SUCH_DIR_OR_FILE";
                    }
                    // 相对路径
                    let temp = this.getCurrentLocation();
                    let isFound = false;
                    for (let i of arr) {
                        isFound = false;
                        if (i == ".") {
                            isFound = true;
                            continue;
                        }
                        if (i == "..") {
                            temp = this.findFather(temp);
                            if (Object.prototype.toString.call(temp) == "[object String]") {
                                return temp;
                            }
                            isFound = true;
                            continue;
                        }
                        for (let ii of temp.content) {
                            if (i == ii.name) {
                                isFound = true;
                                temp = ii;
                                break;
                            }
                        }
                        if (!isFound) {
                            break;
                        }
                    }
                    if (isFound) {
                        return temp;
                    }
                    else {
                        if (arr[0] == "~") {
                            isFound = true;
                            arr.shift();
                        } else return "ERR_NO_SUCH_DIR_OR_FILE";
                        temp = this.getUserDir();
                        if (temp == "ERR_IN_FINDING_USER_DIR") {
                            console.log(temp);
                            return "ERR_IN_FINDING_USER_DIR";
                        }
                        for (let i of arr) {
                            isFound = false;
                            if (i == ".") {
                                isFound = true;
                                continue;
                            }
                            if (i == "..") {
                                temp = this.findFather(temp);
                                if (Object.prototype.toString.call(temp) == "[object String]") {
                                    return temp;
                                }
                                isFound = true;
                                continue;
                            }
                            for (let ii of temp.content) {
                                if (i == ii.name) {
                                    isFound = true;
                                    temp = ii;
                                    break;
                                }
                            }
                            if (!isFound) {
                                break;
                            }
                        }
                        if (isFound) {
                            return temp;
                        }
                    }
                    return "ERR_NO_SUCH_DIR_OR_FILE";
                }
            }
        })
        var commandHistory = new Vue ({
            el: "#commandHistory",
            data: {
                prompts: [],
                commands: [],
                results: [],
            }
        })
        var inputCommand = new Vue ({
            el: "#inputCommand",
            data: {
                isFocused: false,
            },
            methods: {
                exec: function() {
                    event.preventDefault();
                    let command = this.$refs.command.innerText.trim().split(/\s+/);
                    commandHistory.prompts.push(prompt.toString_());
                    commandHistory.commands.push(this.$refs.command.innerText);
                    if (command.length > 1) {
                        if (command[1] == "--help") {
                            commandHistory.results.push(c_help.helpBy__help(command[0]));
                            this.$refs.command.innerHTML = "";
                            return;
                        }
                    }
                    switch (command[0]) {
                        case "ls": {
                            commandHistory.results.push(c_ls.ls(command));
                            break;
                        }
                        case "cd": {
                            commandHistory.results.push(c_cd.cd(command));
                            break;
                        }
                        case "clear": {
                            c_clear.clear();
                            break;
                        }
                        case "shutdown": {
                            commandHistory.results.push(c_shutdown.shutdown(command));
                            break;
                        }
                        case "cat": {
                            commandHistory.results.push(c_cat.cat(command));
                            break;
                        }
                        case "help": {
                            commandHistory.results.push(c_help.help(command));
                            break;
                        }
                        case "": {
                            commandHistory.results.push({isHtml: false, result: ""});
                            break;
                        }
                        default: {
                            commandHistory.results.push({isHtml: false, result: "-ArectShell: command not found: " + command[0]});
                            break;
                        }  
                    }
                    this.$refs.command.innerHTML = "";
                },
                inputFocus: function(b) {
                    if(this.$refs.command.innerText == ''){
                        this.isFocused = b;
                    }
                }
            }
        })
        var d_fileTree = new Vue({
            data: {
                fileTree: [{
                    name: "~",
                    owner: "visitor",
                    isDir: true,
                    content: [{
                        name: "testDir",
                        isDir: true,
                        content: [{
                            name: "second.file",
                            isDir: false,
                            content: ["<h1 style = \"color: #999999\">第二个文件</h1>"]
                        }]
                    },{
                        name: "test.txt",
                        isDir: false,
                        content: ["这是test.txt", "这是test.txt的第二行"]
                    }]
                }]
            }
        })
        var c_ls = new Vue({
            methods: {
                ls: function(arr) {
                    switch (arr.length) {
                        case 1: {
                            let temp = prompt.getCurrentLocation();
                            let tempStr = ""
                            for (let i of temp.content) {
                                if (i.isDir == true) {
                                    tempStr += "<div class = \"helpItem ls_dir\">" + i.name + "</div>";
                                }
                                else {
                                    tempStr += "<div class = \"helpItem\">" + i.name + "</div>";
                                }
                            }
                            if (tempStr == "") {
                                tempStr += "<br />";
                            }
                            return [{isHtml: true, result: tempStr}];
                        }
                        default: {
                            let result = [];
                            for (let i = 1; i < arr.length; i++) {
                                let temp = prompt.enterTargetDir(arr[i]);
                                let tempStr = "";
                                if (Object.prototype.toString.call(temp) == "[object String]") {
                                    if (temp == "ERR_PERMISSION_DENIED") {
                                        result.push({isHtml: false, result: "ls: cannot open directory \'" + arr[i] + "\': Permission denied"});
                                        continue;
                                    }
                                    result.push({isHtml: false, result: "ls: no such file or directory: " + arr[i]});
                                    continue;
                                }
                                if (!temp.isDir) {
                                    result.push({isHtml: true, result: temp.name});
                                    continue;
                                }
                                if (arr.length > 2){
                                    tempStr += arr[i] + ":<br />";
                                }
                                for (let ii of temp.content) {
                                    if (ii.isDir == true) {
                                        tempStr += "<div class = \"helpItem ls_dir\">" + ii.name + "</div>";
                                    }
                                    else {
                                        tempStr += "<div class = \"helpItem\">" + ii.name + "</div>";
                                    }
                                }
                                result.push({isHtml: true, result: tempStr + "<br />"});
                            }
                            return result;
                        }
                    }
                }
            }
        })
        var c_cd = new Vue({
            methods: {
                cd: function(arr) {
                    let result = "";
                    switch (arr.length) {
                        case 1: {
                            return [{isHtml: false, result: ""}];
                        }
                        case 2: {
                            let temp = prompt.enterTargetDir(arr[1]);
                            if (Object.prototype.toString.call(temp) == "[object String]") {
                                if (temp == "ERR_PERMISSION_DENIED") {
                                    return [{isHtml: false, result: "cd: permission denied: " + arr[1]}];
                                }
                                return [{isHtml: false, result: "cd: no such file or directory: " + arr[1]}];
                            }
                            if (!temp.isDir) {
                                return [{isHtml: false, result: "cd: not a directory: " + arr[1]}];
                            }
                            let target = arr[1].replace(new RegExp('^\\/+|\\/+$', 'g'), '').split("/");
                            if (target[0] == "~") {
                                prompt.directory.splice(0,prompt.directory.length);
                            }
                            for (let i of target) {
                                if (i == ".") {
                                    continue;
                                }
                                if (i == "..") {
                                    prompt.directory.pop();
                                    continue;
                                }
                                prompt.directory.push(i);
                            }
                            return [{isHtml: false, result: ""}];
                        }
                        default: {
                            return [{isHtml: false, result: "cd: string not in pwd: " + arr[1]}];
                            break;
                        }
                    }
                    return {isHtml: false, result: ""};
                }
            }
        })
        var c_clear = new Vue({
            methods: {
                clear: function() {
                    commandHistory.prompts.splice(0,commandHistory.prompts.length);
                    commandHistory.commands.splice(0,commandHistory.commands.length);
                    commandHistory.results.splice(0,commandHistory.results.length);
                    return [{isHtml: false, result: ""}];
                }
            }
        })
        var c_shutdown = new Vue({
            methods: {
                shutdown: function(arr) {
                    window.location.href = "about:blank";
                    return [{isHtml: false, result: ""}];
                }
            }
        })
        var c_cat = new Vue({
            methods: {
                cat: function(arr) {
                    switch (arr.length) {
                        case 1: {
                            return [{isHtml: true, result: "<span style = \"color: #E91E63;\">喵~</span>"}];
                            break;
                        }
                        default: {
                            let result = [];
                            for (let i = 1; i < arr.length; i++) {
                                let temp = prompt.enterTargetDir(arr[i]);
                                if (Object.prototype.toString.call(temp) == "[object String]") {
                                    if (temp == "ERR_PERMISSION_DENIED") {
                                        result.push({isHtml: false, result: "cat: " + arr[i] + ": Permission denied"});
                                        continue;
                                    }
                                    result.push({isHtml: false, result: "cat: " + arr[i] + ": No such file or directory"});
                                    continue;
                                }
                                if (temp.isDir) {
                                    result.push({isHtml: false, result: "cat: " + arr[i] + ": Is a directory"});
                                    continue;
                                }
                                for (let ii of temp.content) {
                                    result.push({isHtml: false, result: ii});
                                }
                            }
                            return result;
                        }
                    }
                }
            }
        })
        var c_help = new Vue({
            data: {
                commands: [{
                    name: "cat",
                    describe: "Usage: cat [FILE]...<br />Concatenate FILE to standard output."
                },{
                    name: "cd",
                    describe: "cd: no such file or directory: --help<br />Just a joke."
                },{
                    name: "clear",
                    describe: "Usage: clear<br />Clear history."
                },{
                    name: "help",
                    describe: "Usage: help<br />List the commands which I want you to see."
                },{
                    name: "ls",
                    describe: "Usage: ls [FILE/DIR]...<br />List the FILEs (the current directory by default)."
                },{
                    name: "shutdown",
                    describe: "Usage: shutdown<br />Switch to blank page."
                }]
            },
            methods: {
                helpBy__help: function(name) {
                    for (let i of this.commands) {
                        if (i.name == name) {
                            return [{isHtml: true, result: i.describe}];
                        }
                    }
                    return [{isHtml: false, result: "-ArectShell: command not found:&ensp;" + name}];
                },
                help: function(arr) {
                    let temp = "";
                    for (let i of this.commands) {
                        temp += "<div class = \"helpItem\">" + i.name + "</div>";
                    }
                    return [{isHtml: true, result: temp}];
                }
            }
        })
    </script>
</html>